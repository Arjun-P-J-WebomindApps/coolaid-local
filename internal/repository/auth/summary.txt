D:\Local\coolaid-backend-model\internal\repository\auth\adaptor.go
package auth

import (
	"context"
	"database/sql"

	"github.com/webomindapps-dev/coolaid-backend/db"
	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
)

// AuthDB is the database adapter for the auth domain.
// It implements auth.DB and returns auth.Queries.
type AuthDB struct {
	db      *sql.DB
	queries *sqlc.Queries
}

func NewAuthRepository(dbCtx *db.DBContext) *AuthDB {
	return &AuthDB{
		db:      dbCtx.SqlDB,
		queries: dbCtx.Queries,
	}
}

type authQueries struct {
	q *sqlc.Queries
}

// Compile-time guarantee that authQueries implements auth.Queries
var _ auth.Queries = (*authQueries)(nil)

func (a *AuthDB) BeginTx(
	ctx context.Context,
) (*sql.Tx, auth.Queries, error) {

	tx, err := a.db.BeginTx(ctx, nil)
	if err != nil {
		return nil, nil, err
	}

	return tx, &authQueries{
		q: sqlc.New(tx),
	}, nil
}

func (a *AuthDB) Queries() auth.Queries {
	return &authQueries{
		q: sqlc.New(a.db),
	}
}

D:\Local\coolaid-backend-model\internal\repository\auth\mapping.go
package auth

import (
	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
	"github.com/webomindapps-dev/coolaid-backend/internal/shared/sqlnull"
)

func mapUserRow(row sqlc.User) *auth.UserRow {
	return &auth.UserRow{
		ID:       auth.ID(row.ID.String()),
		Name:     row.Name,
		Username: row.Username,
		Email:    row.Email,
		Password: row.Password,
		Mobile:   row.Mobile,
		Role:     row.Role,
		IsActive: row.IsActive,
	}
}

func mapSessionRow(row sqlc.UserSession) *auth.SessionRow {
	return &auth.SessionRow{
		SessionID: auth.ID(row.SessionID.String()),
		UserID:    auth.ID(row.UserID.String()),
		ExpiresAt: row.ExpiresAt,
		RevokedAt: sqlnull.TimePtr(row.RevokedAt),
	}
}

D:\Local\coolaid-backend-model\internal\repository\auth\otp.go
package auth

import (
	"context"

	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
)

func (q *authQueries) CreateOTP(
	ctx context.Context,
	p auth.CreateOTPParams,
) error {

	uid, err := p.UserID.ToUUID(ctx)
	if err != nil {
		return err
	}

	_, errOTP := q.q.CreateOTP(ctx, sqlc.CreateOTPParams{
		UserID:    uid,
		OtpCode:   p.OtpCode,
		ExpiresAt: p.ExpiresAt,
	})

	return errOTP
}

func (q *authQueries) GetLatestOTPFromUser(
	ctx context.Context,
	userID auth.ID,
) (*auth.OTPRow, error) {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.GetLatestOTPFromUser(ctx, uid)
	if err != nil {
		return nil, err
	}

	return &auth.OTPRow{
		UserID:    userID,
		OtpCode:   row.OtpCode,
		ExpiresAt: row.ExpiresAt,
		IsUsed:    row.IsUsed,
	}, nil
}

func (q *authQueries) DeleteUserOTPByUserId(
	ctx context.Context,
	userID auth.ID,
) error {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return err
	}

	return q.q.DeleteUserOTPByUserId(ctx, uid)
}

func (q *authQueries) MarkOTPAsUsed(
	ctx context.Context,
	userID auth.ID,
) error {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return err
	}

	return q.q.MarkOTPAsUsed(ctx, uid)
}

D:\Local\coolaid-backend-model\internal\repository\auth\refreshToken.go
package auth

import (
	"context"

	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
	"github.com/webomindapps-dev/coolaid-backend/internal/shared/sqlnull"
)

func (q *authQueries) CreateRefreshToken(
	ctx context.Context,
	p auth.CreateRefreshTokenParams,
) error {

	uid, err := p.UserID.ToUUID(ctx)
	if err != nil {
		return err
	}

	sid, err := p.SessionID.ToUUID(ctx)
	if err != nil {
		return err
	}

	_, errToken := q.q.CreateRefreshToken(ctx, sqlc.CreateRefreshTokenParams{
		UserID:    uid,
		SessionID: sid,
		TokenHash: p.TokenHash,
		ExpiresAt: p.ExpiresAt,
	})

	return errToken
}

func (q *authQueries) DeleteRefreshTokensBySession(
	ctx context.Context,
	sessionID auth.ID,
) error {

	sid, err := sessionID.ToUUID(ctx)
	if err != nil {
		return err
	}

	return q.q.DeleteRefreshTokensBySession(ctx, sid)
}

func (q *authQueries) GetRefreshTokenByHash(
	ctx context.Context,
	hash string,
) (*auth.RefreshTokenRow, error) {

	row, err := q.q.GetRefreshTokenByHash(ctx, hash)
	if err != nil {
		return nil, err
	}

	return &auth.RefreshTokenRow{
		ID:        auth.ID(row.ID.String()),
		UserID:    auth.ID(row.UserID.String()),
		SessionID: auth.ID(row.SessionID.String()),
		TokenHash: row.TokenHash,
		ExpiresAt: row.ExpiresAt,
		RevokedAt: sqlnull.TimePtr(row.RevokedAt),
		CreatedAt: row.CreatedAt,
	}, nil
}

D:\Local\coolaid-backend-model\internal\repository\auth\session.go
package auth

import (
	"context"

	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
)

func (q *authQueries) GetUserSessionByUserId(
	ctx context.Context,
	userID auth.ID,
) (*auth.SessionRow, error) {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.GetUserSessionByUserId(ctx, uid)
	if err != nil {
		return nil, err
	}

	return mapSessionRow(row), nil
}

func (q *authQueries) GetUserSessionById(
	ctx context.Context,
	sessionID auth.ID,
) (*auth.SessionRow, error) {

	sid, err := sessionID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.GetUserSessionById(ctx, sid)
	if err != nil {
		return nil, err
	}

	return mapSessionRow(row), nil
}

func (q *authQueries) CreateUserSession(
	ctx context.Context,
	p auth.CreateSessionParams,
) (*auth.SessionRow, error) {

	uid, err := p.UserID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	sid, err := p.SessionID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.CreateUserSession(ctx, sqlc.CreateUserSessionParams{
		UserID:    uid,
		SessionID: sid,
		IpAddress: p.IP,
		UserAgent: p.UserAgent,
		ExpiresAt: p.ExpiresAt,
	})
	if err != nil {
		return nil, err
	}

	return mapSessionRow(row), nil
}

func (q *authQueries) DeleteUserSession(
	ctx context.Context,
	sessionID auth.ID,
) error {

	sid, err := sessionID.ToUUID(ctx)
	if err != nil {
		return err
	}

	return q.q.DeleteUserSession(ctx, sid)
}

D:\Local\coolaid-backend-model\internal\repository\auth\toptp.go
package auth

import (
	"context"

	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
)

func (q *authQueries) GetUserTotpByUserID(
	ctx context.Context,
	userID auth.ID,
) (*auth.UserTotpRow, error) {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.GetUserTotpByUserID(ctx, uid)
	if err != nil {
		return nil, err
	}

	return &auth.UserTotpRow{
		UserID: userID,
		Secret: row.Secret,
	}, nil
}

func (q *authQueries) CreateUserTotp(
	ctx context.Context,
	p auth.CreateUserTotpParams,
) error {

	uid, err := p.UserID.ToUUID(ctx)
	if err != nil {
		return err
	}

	_, errTOTP := q.q.CreateUserTotp(ctx, sqlc.CreateUserTotpParams{
		UserID: uid,
		Secret: p.Secret,
	})

	return errTOTP
}

D:\Local\coolaid-backend-model\internal\repository\auth\user.go
package auth

import (
	"context"

	"github.com/google/uuid"
	"github.com/webomindapps-dev/coolaid-backend/internal/domain/auth"
	"github.com/webomindapps-dev/coolaid-backend/internal/generated/sqlc"
	"github.com/webomindapps-dev/coolaid-backend/internal/shared/sqlnull"
)

func (q *authQueries) GetUserByEmail(
	ctx context.Context,
	email string,
) (*auth.UserRow, error) {

	row, err := q.q.GetUserByEmail(ctx, email)
	if err != nil {
		return nil, err
	}

	return mapUserRow(row), nil
}

func (q *authQueries) GetUserByUsername(
	ctx context.Context,
	username string,
) (*auth.UserRow, error) {

	row, err := q.q.GetUserByUsername(ctx, username)
	if err != nil {
		return nil, err
	}

	return mapUserRow(row), nil
}

func (q *authQueries) GetUserById(
	ctx context.Context,
	id auth.ID,
) (*auth.UserRow, error) {

	uid, err := id.ToUUID(ctx)
	if err != nil {
		return nil, err
	}

	row, err := q.q.GetUserById(ctx, uid)
	if err != nil {
		return nil, err
	}

	return mapUserRow(row), nil
}

func (q *authQueries) CreateUser(
	ctx context.Context,
	p auth.CreateUserParams,
) (*auth.UserRow, error) {

	row, err := q.q.CreateUser(ctx, sqlc.CreateUserParams{
		ID:        uuid.MustParse(string(p.ID)),
		Name:      p.Name,
		Username:  p.Username,
		Email:     p.Email,
		Password:  p.Password,
		Mobile:    p.Mobile,
		Role:      p.Role,
		IsActive:  p.IsActive,
		CreatedAt: p.CreatedAt,
		UpdatedAt: p.UpdatedAt,
	})
	if err != nil {
		return nil, err
	}

	return mapUserRow(row), nil
}

func (q *authQueries) UpdateUserPassword(
	ctx context.Context,
	userID auth.ID,
	hashedPassword string,
) error {

	uid, err := userID.ToUUID(ctx)
	if err != nil {
		return err
	}

	return q.q.UpdateUser(ctx, sqlc.UpdateUserParams{
		ID:       uid,
		Password: sqlnull.String(&hashedPassword),
	})
}

