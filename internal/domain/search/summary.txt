D:\Local\coolaid-backend-model\internal\domain\search\detector.go
package search

import "strings"

// extractPartToken checks if first token looks like a part number.
// Must contain at least one letter and one digit.
// Allows hyphen.
func extractPartToken(q string) (string, bool) {
	s := strings.TrimSpace(q)
	if s == "" {
		return "", false
	}

	s = strings.Join(strings.Fields(s), " ")
	first := strings.SplitN(s, " ", 2)[0]

	hasLetter := false
	hasDigit := false

	for _, r := range first {
		switch {
		case r >= 'A' && r <= 'Z':
			hasLetter = true
		case r >= 'a' && r <= 'z':
			hasLetter = true
		case r >= '0' && r <= '9':
			hasDigit = true
		case r == '-':
			// allowed
		default:
			return "", false
		}
	}

	if hasLetter && hasDigit {
		return first, true
	}

	return "", false
}

D:\Local\coolaid-backend-model\internal\domain\search\interfaces.go
package search

import "context"

// Business search service
type Service interface {
	GetSuggestions(ctx context.Context, query string, queryBy string) (*Results, error)
}

// Typesense adapter
type SearchEngine interface {
	Search(ctx context.Context, req SearchRequest) (*SearchResponse, error)
}

// Index adapter
type Indexer interface {
	Index(ctx context.Context, req IndexRequest) error
	Update(ctx context.Context, req IndexRequest) error
	Delete(ctx context.Context, collection string, id string) error
}

// DB-based priority suggestions
type PriorityRepository interface {

	//Even though number, check if its a model name
	GetModelSimilar(ctx context.Context, token string) (bool, error)

	// Base Data + Primary Lookup ID (Part No)
	GetPartSuggestions(ctx context.Context, token string, limit int) ([]PartData, error)
	GetOemSuggestions(ctx context.Context, token string, limit int) ([]PartData, error)
	GetVendorSuggestions(ctx context.Context, token string, limit int) ([]PartData, error)
}

D:\Local\coolaid-backend-model\internal\domain\search\models.go
package search

//========================================================================
// Store
//=======================================================================

type IndexRequest struct {
	Collection string
	ID         string
	Payload    any
}

type ProductSearchDocument struct {
	ID       string `json:"id"`
	Company  string `json:"company"`
	Model    string `json:"model"`
	PartNo   string `json:"part_no"`
	Brand    string `json:"brand"`
	Category string `json:"category"`
}

//=====================================================================
//     Search
//====================================================================

// Raw request to search engine
type SearchRequest struct {
	Collection string
	Query      string
	QueryBy    string
	PerPage    int
	Page       int
}

// Raw response from search engine
type SearchResponse struct {
	Found int
	Page  int
	Hits  []SearchHit
}

type SearchHit struct {
	Document   map[string]any
	Highlights []Highlight
}

type Highlight struct {
	Field         string   `json:"field"`
	Snippet       string   `json:"snippet"`
	MatchedTokens []string `json:"matched_tokens,omitempty"`
}

type Results struct {
	Hits []Hit `json:"hits"`
}

type Hit struct {
	Document   Document    `json:"document"`
	Highlights []Highlight `json:"highlight,omitempty"`
	Score      float64     `json:"score,omitempty"` // optional internal usage
}

type Document struct {
	ID        string `json:"id"`
	Company   string `json:"company,omitempty"`
	Model     string `json:"model,omitempty"`
	ModelType string `json:"model_type,omitempty"`
	Category  string `json:"category,omitempty"`
	Brand     string `json:"brand,omitempty"`
	PartNo    string `json:"part_no,omitempty"`
	FuelType  string `json:"fuel_type,omitempty"`
	Gen       string `json:"gen,omitempty"`
}

type PartData struct {
	ID       string `json:"id"`
	PartNo   string `json:"part_no,omitempty"`
	OemNo    string `json:"oem_no,omitempty"`
	VendorNo string `json:"vendor_no,omitempty"`
}

D:\Local\coolaid-backend-model\internal\domain\search\scorer.go
package search

import (
	"regexp"
	"strings"
)

var tagRe = regexp.MustCompile("</?mark>")

var fieldsForCloseness = []string{
	"model",
	"category",
	"brand",
	"company",
	"part_no",
}

func countMarkedTokens(snippet string) (marked int) {
	parts := strings.Split(snippet, "<mark>")
	for i := 1; i < len(parts); i++ {
		end := strings.Index(parts[i], "</mark>")
		if end < 0 {
			continue
		}
		marked += len(tokenizePlain(parts[i][:end]))
	}
	return
}

func markClosenessScore(highlights []Highlight) float64 {

	score := 0.0

	for _, h := range highlights {
		marked := countMarkedTokens(h.Snippet)

		switch h.Field {
		case "part_no":
			score += float64(marked) * 5
		case "model":
			score += float64(marked) * 3
		case "brand":
			score += float64(marked) * 2
		default:
			score += float64(marked)
		}
	}

	return score
}

D:\Local\coolaid-backend-model\internal\domain\search\service.go

D:\Local\coolaid-backend-model\internal\domain\search\tokenizer.go
package search

import "strings"

// tokenizePlain splits string into lowercase tokens.
// Keeps hyphen intact.
func tokenizePlain(s string) []string {
	s = strings.ToLower(strings.TrimSpace(s))
	if s == "" {
		return nil
	}

	s = strings.Join(strings.Fields(s), " ")
	return strings.Fields(s)
}

