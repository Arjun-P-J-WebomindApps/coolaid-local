name: CI & CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build & Push Image
    runs-on: [self-hosted, backend]
    environment: 'coolaid-backend'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate .env from secrets
        run: |
          cat <<EOF > .env
          APP_NAME=${{ secrets.APP_NAME }}
          APP_ENV=${{ secrets.APP_ENV }}
          APP_PORT=${{ secrets.APP_PORT }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSL_MODE=${{ secrets.DB_SSL_MODE }}
          SEARCH_ENGINE_TYPESENSE_API_ENDPOINT=${{ secrets.SEARCH_ENGINE_TYPESENSE_API_ENDPOINT }}
          SEARCH_ENGINE_TYPESENSE_API_KEY=${{ secrets.SEARCH_ENGINE_TYPESENSE_API_KEY }}
          WHATSAPP_API_VERSION=${{secrets.WHATSAPP_API_VERSION}}
          WHATSAPP_ACCESS_TOKEN=${{secrets.WHATSAPP_ACCESS_TOKEN}}
          WHATSAPP_PHONE_NUMBER_ID=${{secrets.WHATSAPP_PHONE_NUMBER_ID}}
          EOF

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: true
          tags: webomindapps1/coolaid-backend:latest
          # Because .env is already on disk, Next.js will pick it up during `npm run build`
          # No further build-args needed

  deploy:
    name: Deploy to Self-Hosted
    needs: build
    runs-on: [self-hosted, backend]
    environment: 'coolaid-backend'
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
  
      - name: Pull latest image
        run: |
          docker pull webomindapps1/coolaid-backend:latest
      
      - name: Stop and cleanup existing deployment
        run: |
          sudo docker stop cicd-pipeline-container 2>/dev/null || true
          sudo docker rm -f cicd-pipeline-container 2>/dev/null || true
          sleep 2
          sudo fuser -k 8000/tcp 2>/dev/null || true
          sleep 1
      
      - name: Generate .env on deploy-host
        run: |
          cat <<EOF > .env
          APP_NAME=${{ secrets.APP_NAME }}
          APP_ENV=${{ secrets.APP_ENV }}
          APP_PORT=${{ secrets.APP_PORT }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSL_MODE=${{ secrets.DB_SSL_MODE }}
          SEARCH_ENGINE_TYPESENSE_API_ENDPOINT=${{ secrets.SEARCH_ENGINE_TYPESENSE_API_ENDPOINT }}
          SEARCH_ENGINE_TYPESENSE_API_KEY=${{ secrets.SEARCH_ENGINE_TYPESENSE_API_KEY }}
          WHATSAPP_API_VERSION=${{secrets.WHATSAPP_API_VERSION}}
          WHATSAPP_ACCESS_TOKEN=${{secrets.WHATSAPP_ACCESS_TOKEN}}
          WHATSAPP_PHONE_NUMBER_ID=${{secrets.WHATSAPP_PHONE_NUMBER_ID}}
          EOF
      
      - name: Run new container
        run: |
          docker run -d \
            --name cicd-pipeline-container \
            -p 8000:8000 \
            --restart always \
            --env-file .env \
            webomindapps1/coolaid-backend:latest
